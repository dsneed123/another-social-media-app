<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Story</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
        }

        .post-btn {
            background: #B39FFF;
            color: white;
            border: none;
            padding: 8px 24px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }

        .post-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        /* Main Container */
        .create-container {
            position: relative;
            width: 100%;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        /* Upload State */
        .upload-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 32px;
            padding: 20px;
        }

        .upload-state.hidden {
            display: none;
        }

        .upload-icon {
            font-size: 80px;
            color: #B39FFF;
        }

        .upload-text {
            text-align: center;
        }

        .upload-text h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .upload-text p {
            color: #999;
            font-size: 14px;
        }

        .upload-options {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .upload-btn {
            background: #2c2c2c;
            border: 2px solid #444;
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }

        .upload-btn:hover {
            border-color: #B39FFF;
            background: #333;
        }

        .upload-btn i {
            font-size: 24px;
        }

        input[type="file"] {
            display: none;
        }

        /* Preview State */
        .preview-state {
            display: none;
            width: 100%;
            height: 100vh;
            position: relative;
        }

        .preview-state.active {
            display: block;
        }

        #preview-media {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #preview-canvas {
            width: 100%;
            height: 100%;
            display: none;
        }

        #preview-canvas.active {
            display: block;
        }

        /* Editing Tools */
        .edit-tools {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            backdrop-filter: blur(10px);
        }

        .tool-row {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 8px 0;
        }

        .tool-btn {
            background: #2c2c2c;
            border: 2px solid #444;
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            min-width: 80px;
            transition: all 0.2s;
        }

        .tool-btn:hover,
        .tool-btn.active {
            border-color: #B39FFF;
            background: #333;
        }

        .tool-btn i {
            font-size: 20px;
        }

        .tool-btn span {
            font-size: 11px;
        }

        /* Text Editor */
        .text-editor {
            display: none;
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
        }

        .text-editor.active {
            display: block;
        }

        .text-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #444;
            border-radius: 8px;
            background: #2c2c2c;
            color: white;
            font-size: 16px;
            margin-bottom: 12px;
        }

        .color-picker-row {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 12px;
        }

        .color-option {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .color-option.selected {
            border-color: white;
        }

        .size-slider {
            width: 100%;
            margin-bottom: 12px;
        }

        .text-actions {
            display: flex;
            gap: 8px;
        }

        .text-actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .text-actions .cancel-btn {
            background: #444;
            color: white;
        }

        .text-actions .add-btn {
            background: #B39FFF;
            color: white;
        }

        /* Canvas Text Elements */
        .canvas-text {
            position: absolute;
            color: white;
            font-weight: 600;
            cursor: move;
            user-select: none;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            padding: 8px 12px;
            border-radius: 4px;
        }

        /* Filter Options */
        .filter-options {
            display: none;
            gap: 12px;
            overflow-x: auto;
            padding: 8px 0;
        }

        .filter-options.active {
            display: flex;
        }

        .filter-btn {
            min-width: 80px;
            padding: 8px 16px;
            background: #2c2c2c;
            border: 2px solid #444;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .filter-btn.selected {
            border-color: #B39FFF;
        }

        /* Compression Info */
        .compression-info {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(179, 159, 255, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: none;
        }

        .compression-info.active {
            display: block;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #333;
            border-top-color: #B39FFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <button class="back-btn" onclick="goBack()">
                <i class="bi bi-x-lg"></i>
            </button>
            <span class="header-title">Create Story</span>
        </div>
        <button class="post-btn" id="post-btn" onclick="postStory()" disabled>Post</button>
    </div>

    <!-- Compression Info -->
    <div class="compression-info" id="compression-info"></div>

    <!-- Main Container -->
    <div class="create-container">
        <!-- Upload State -->
        <div class="upload-state" id="upload-state">
            <div class="upload-icon">
                <i class="bi bi-camera-fill"></i>
            </div>
            <div class="upload-text">
                <h2>Create Your Story</h2>
                <p>Share a photo or video with your friends</p>
            </div>
            <div class="upload-options">
                <label class="upload-btn">
                    <i class="bi bi-camera"></i>
                    <span>Take Photo</span>
                    <input type="file" id="camera-input" accept="image/*" capture="environment">
                </label>
                <label class="upload-btn">
                    <i class="bi bi-image"></i>
                    <span>Choose Photo</span>
                    <input type="file" id="photo-input" accept="image/*">
                </label>
                <label class="upload-btn">
                    <i class="bi bi-play-circle"></i>
                    <span>Choose Video</span>
                    <input type="file" id="video-input" accept="video/*">
                </label>
            </div>
        </div>

        <!-- Preview State -->
        <div class="preview-state" id="preview-state">
            <img id="preview-media" style="display: none;">
            <video id="preview-video" style="display: none;" controls></video>
            <canvas id="preview-canvas"></canvas>
        </div>
    </div>

    <!-- Editing Tools -->
    <div class="edit-tools" id="edit-tools" style="display: none;">
        <div class="tool-row">
            <button class="tool-btn" onclick="toggleTextEditor()">
                <i class="bi bi-fonts"></i>
                <span>Text</span>
            </button>
            <button class="tool-btn" onclick="toggleFilters()">
                <i class="bi bi-palette"></i>
                <span>Filters</span>
            </button>
            <button class="tool-btn" onclick="cropMedia()">
                <i class="bi bi-crop"></i>
                <span>Crop</span>
            </button>
            <button class="tool-btn" onclick="rotateMedia()">
                <i class="bi bi-arrow-clockwise"></i>
                <span>Rotate</span>
            </button>
            <button class="tool-btn" onclick="adjustBrightness()">
                <i class="bi bi-brightness-high"></i>
                <span>Brightness</span>
            </button>
        </div>

        <!-- Filter Options -->
        <div class="filter-options" id="filter-options">
            <button class="filter-btn selected" onclick="applyFilter('none')">Original</button>
            <button class="filter-btn" onclick="applyFilter('grayscale')">B&W</button>
            <button class="filter-btn" onclick="applyFilter('sepia')">Sepia</button>
            <button class="filter-btn" onclick="applyFilter('vintage')">Vintage</button>
            <button class="filter-btn" onclick="applyFilter('bright')">Bright</button>
            <button class="filter-btn" onclick="applyFilter('cool')">Cool</button>
            <button class="filter-btn" onclick="applyFilter('warm')">Warm</button>
        </div>
    </div>

    <!-- Text Editor -->
    <div class="text-editor" id="text-editor">
        <input type="text" class="text-input" id="text-input" placeholder="Add text...">
        <div class="color-picker-row">
            <div class="color-option selected" style="background: white;" onclick="selectColor('white')"></div>
            <div class="color-option" style="background: black;" onclick="selectColor('black')"></div>
            <div class="color-option" style="background: #B39FFF;" onclick="selectColor('#B39FFF')"></div>
            <div class="color-option" style="background: #ff4444;" onclick="selectColor('#ff4444')"></div>
            <div class="color-option" style="background: #44ff44;" onclick="selectColor('#44ff44')"></div>
            <div class="color-option" style="background: #ffff44;" onclick="selectColor('#ffff44')"></div>
        </div>
        <input type="range" class="size-slider" id="size-slider" min="16" max="72" value="32">
        <div class="text-actions">
            <button class="cancel-btn" onclick="closeTextEditor()">Cancel</button>
            <button class="add-btn" onclick="addText()">Add Text</button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Compressing and uploading...</p>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let isVideo = false;
        let canvas, ctx;
        let currentFilter = 'none';
        let rotation = 0;
        let brightness = 1;
        let textElements = [];
        let selectedTextColor = 'white';
        let selectedTextSize = 32;
        let originalImage = null;

        // Initialize
        document.getElementById('camera-input').addEventListener('change', handleFileSelect);
        document.getElementById('photo-input').addEventListener('change', handleFileSelect);
        document.getElementById('video-input').addEventListener('change', handleFileSelect);

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            selectedFile = file;
            isVideo = file.type.startsWith('video/');

            // Show compression info
            showCompressionInfo(file);

            // Load preview
            loadPreview(file);
        }

        function showCompressionInfo(file) {
            const sizeMB = (file.size / 1024 / 1024).toFixed(2);
            const info = document.getElementById('compression-info');
            info.textContent = `Original: ${sizeMB}MB - Will be compressed`;
            info.classList.add('active');

            setTimeout(() => {
                info.classList.remove('active');
            }, 3000);
        }

        function loadPreview(file) {
            document.getElementById('upload-state').classList.add('hidden');
            document.getElementById('preview-state').classList.add('active');
            document.getElementById('edit-tools').style.display = 'block';
            document.getElementById('post-btn').disabled = false;

            const reader = new FileReader();
            reader.onload = (e) => {
                if (isVideo) {
                    const video = document.getElementById('preview-video');
                    video.src = e.target.result;
                    video.style.display = 'block';
                    document.getElementById('preview-canvas').style.display = 'none';
                } else {
                    const img = new Image();
                    img.onload = () => {
                        originalImage = img;
                        setupCanvas(img);
                    };
                    img.src = e.target.result;
                }
            };
            reader.readAsDataURL(file);
        }

        function setupCanvas(img) {
            canvas = document.getElementById('preview-canvas');
            ctx = canvas.getContext('2d');

            // Set canvas size to fit screen while maintaining aspect ratio
            const maxWidth = window.innerWidth;
            const maxHeight = window.innerHeight;
            const ratio = Math.min(maxWidth / img.width, maxHeight / img.height);

            canvas.width = img.width * ratio;
            canvas.height = img.height * ratio;

            canvas.classList.add('active');
            drawCanvas();
        }

        function drawCanvas() {
            if (!originalImage || !ctx) return;

            ctx.save();
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Apply transformations
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate(rotation * Math.PI / 180);
            ctx.translate(-canvas.width / 2, -canvas.height / 2);

            // Apply filters
            ctx.filter = getFilterString();
            ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);

            ctx.restore();

            // Draw text elements
            textElements.forEach(text => {
                ctx.font = `${text.size}px Arial`;
                ctx.fillStyle = text.color;
                ctx.textAlign = 'center';
                ctx.fillText(text.content, text.x, text.y);
            });
        }

        function getFilterString() {
            let filter = `brightness(${brightness}) `;

            switch(currentFilter) {
                case 'grayscale':
                    filter += 'grayscale(100%)';
                    break;
                case 'sepia':
                    filter += 'sepia(100%)';
                    break;
                case 'vintage':
                    filter += 'sepia(50%) contrast(1.2) brightness(1.1)';
                    break;
                case 'bright':
                    filter += 'brightness(1.3) contrast(1.1)';
                    break;
                case 'cool':
                    filter += 'hue-rotate(180deg) saturate(1.2)';
                    break;
                case 'warm':
                    filter += 'sepia(30%) saturate(1.4)';
                    break;
                default:
                    break;
            }

            return filter;
        }

        // Text Editor Functions
        function toggleTextEditor() {
            const editor = document.getElementById('text-editor');
            editor.classList.toggle('active');
        }

        function closeTextEditor() {
            document.getElementById('text-editor').classList.remove('active');
            document.getElementById('text-input').value = '';
        }

        function selectColor(color) {
            selectedTextColor = color;
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        document.getElementById('size-slider').addEventListener('input', (e) => {
            selectedTextSize = parseInt(e.target.value);
        });

        function addText() {
            const text = document.getElementById('text-input').value.trim();
            if (!text) return;

            textElements.push({
                content: text,
                color: selectedTextColor,
                size: selectedTextSize,
                x: canvas.width / 2,
                y: canvas.height / 2
            });

            drawCanvas();
            closeTextEditor();
        }

        // Filter Functions
        function toggleFilters() {
            const filters = document.getElementById('filter-options');
            filters.classList.toggle('active');
        }

        function applyFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            drawCanvas();
        }

        // Transform Functions
        function rotateMedia() {
            rotation = (rotation + 90) % 360;
            drawCanvas();
        }

        function adjustBrightness() {
            brightness = brightness >= 1.5 ? 0.5 : brightness + 0.25;
            drawCanvas();
        }

        function cropMedia() {
            alert('Crop feature coming soon!');
        }

        // Compress and Upload
        async function compressImage(file, maxSizeMB = 5) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // Resize if too large
                        let width = img.width;
                        let height = img.height;
                        const maxDim = 1920;

                        if (width > maxDim || height > maxDim) {
                            if (width > height) {
                                height = (height / width) * maxDim;
                                width = maxDim;
                            } else {
                                width = (width / height) * maxDim;
                                height = maxDim;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);

                        // Compress
                        let quality = 0.8;
                        canvas.toBlob((blob) => {
                            const sizeMB = blob.size / 1024 / 1024;
                            if (sizeMB > maxSizeMB && quality > 0.3) {
                                quality -= 0.1;
                                canvas.toBlob(resolve, 'image/jpeg', quality);
                            } else {
                                resolve(blob);
                            }
                        }, 'image/jpeg', quality);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function compressVideo(file, maxSizeMB = 50) {
            // For videos, we'll just ensure they're under max size
            // Full video compression requires ffmpeg or similar
            if (file.size / 1024 / 1024 > maxSizeMB) {
                alert('Video is too large. Please select a smaller video (under 50MB).');
                return null;
            }
            return file;
        }

        async function postStory() {
            document.getElementById('loading-overlay').classList.add('active');

            try {
                // Get user info
                const userData = JSON.parse(localStorage.getItem('user') || '{}');
                const userId = userData.id;

                if (!userId) {
                    alert('Please login first');
                    window.location.href = '/';
                    return;
                }

                let finalBlob;

                if (isVideo) {
                    finalBlob = await compressVideo(selectedFile);
                    if (!finalBlob) {
                        document.getElementById('loading-overlay').classList.remove('active');
                        return;
                    }
                } else {
                    // Get the canvas with all edits
                    finalBlob = await new Promise(resolve => {
                        canvas.toBlob(resolve, 'image/jpeg', 0.8);
                    });
                }

                // Upload to server with story metadata
                const formData = new FormData();
                // Use timestamp to ensure unique filenames for each story
                const timestamp = Date.now();
                formData.append('file', finalBlob, isVideo ? `story_${timestamp}.mp4` : `story_${timestamp}.jpg`);
                formData.append('user_id', userId);
                formData.append('media_type', isVideo ? 'video' : 'image');
                
                // Add caption if text was added
                if (textElements.length > 0) {
                    const caption = textElements.map(t => t.content).join(' ');
                    formData.append('caption', caption);
                }

                const response = await fetch('/api/stories/create', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Story created:', data);

                    // Show success
                    alert('Story posted successfully!');
                    // Force reload by adding timestamp to clear cache
                    window.location.href = '/stories.html?refresh=' + Date.now();
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || 'Upload failed');
                }
            } catch (error) {
                console.error('Error posting story:', error);
                alert('Failed to post story. Please try again.');
            } finally {
                document.getElementById('loading-overlay').classList.remove('active');
            }
        }

        function goBack() {
            if (confirm('Discard this story?')) {
                window.location.href = '/stories';
            }
        }
    </script>
</body>
</html>
