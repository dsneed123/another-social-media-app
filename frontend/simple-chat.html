<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat</title>
    <script src="config.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { max-width: 100vw; overflow-x: hidden; }
        body { font-family: Arial, sans-serif; display: flex; height: 100vh; }

        /* Left sidebar - chats list */
        .sidebar { width: 250px; border-right: 1px solid #ddd; overflow-y: auto; }
        .sidebar h3 { padding: 15px; background: #f5f5f5; border-bottom: 1px solid #ddd; }
        .chat-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .chat-item:hover { background: #f9f9f9; }
        .chat-item.active { background: #e3f2fd; }

        /* Main chat area */
        .main { flex: 1; display: flex; flex-direction: column; }
        .header { padding: 15px; background: #f5f5f5; border-bottom: 1px solid #ddd; }
        .messages { flex: 1; overflow-y: auto; padding: 20px; }

        /* Messages */
        .message { margin: 10px 0; max-width: 70%; }
        .message.sent { margin-left: auto; text-align: right; }
        .message.received { margin-right: auto; }
        .message-bubble { display: inline-block; padding: 10px 15px; border-radius: 15px; }
        .message.sent .message-bubble { background: #007bff; color: white; }
        .message.received .message-bubble { background: #f1f1f1; }
        .message-time { font-size: 11px; color: #999; margin-top: 3px; }
        .message img { max-width: 300px; border-radius: 10px; }

        /* Input */
        .input-area {
            display: flex;
            padding: 15px;
            border-top: 1px solid #ddd;
            gap: 10px;
            max-width: 100vw;
            box-sizing: border-box;
        }
        input {
            flex: 1;
            min-width: 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 16px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background: #007bff;
            color: white;
            cursor: pointer;
            min-height: 44px;
            flex-shrink: 0;
        }
        button:hover { background: #0056b3; }

        .status { font-size: 12px; color: #666; padding: 5px 15px; }

        /* Mobile improvements */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main {
                width: 100%;
                max-width: 100vw;
            }
            .input-area {
                padding: 10px;
                gap: 8px;
                position: sticky;
                bottom: 0;
                background: white;
                left: 0;
                right: 0;
                width: 100%;
                max-width: 100vw;
            }
            input {
                font-size: 16px;
                padding: 12px 16px;
                min-width: 0;
            }
            button {
                min-width: 60px;
                min-height: 48px;
                font-size: 16px;
                font-weight: 600;
                padding: 12px 20px;
                flex-shrink: 0;
            }
            button:active { transform: scale(0.95); }
            .message img { max-width: 100%; max-width: min(250px, 80vw); }
            .message { max-width: 85%; }
        }
        button[onclick*="sendText"] {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-width: 80px;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
            transition: all 0.2s;
        }
        button[onclick*="sendText"]:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.6);
        }
        button[onclick*="sendText"]:active { transform: scale(0.95); }
        button[onclick*="takeSnap"] {
            font-size: 24px;
            padding: 8px 16px;
            background: transparent;
            border: 2px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3 id="username">Loading...</h3>
        <div id="chat-list"></div>
    </div>

    <div class="main">
        <div class="header">
            <strong id="chat-name">Select a chat</strong>
            <div class="status" id="status">Connecting...</div>
        </div>

        <div class="messages" id="messages"></div>

        <div class="input-area">
            <button onclick="takeSnap()">ðŸ“·</button>
            <input type="text" id="input" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendText()">
            <button onclick="sendText()">Send</button>
        </div>
    </div>

    <!-- Hidden webcam -->
    <video id="video" style="display:none" autoplay></video>
    <canvas id="canvas" style="display:none"></canvas>

    <script>
        let ws, userId, chatId;
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const savedChat = JSON.parse(localStorage.getItem('currentChatRoom') || '{}');

        userId = user.id;
        chatId = savedChat.id;

        document.getElementById('username').textContent = user.username || 'Guest';

        if (!userId) {
            alert('Please select a user first');
            window.location.href = '/';
        }

        // Connect WebSocket
        ws = new WebSocket(`${CONFIG.WS_URL}/ws/${userId}`);

        ws.onopen = () => console.log("WebSocket connected");

        ws.onclose = () => {
            console.log("WebSocket closed, reconnecting in 3s...");
            setTimeout(() => location.reload(), 3000);
        };

        ws.onerror = (error) => console.error("WebSocket error:", error);

        ws.onopen = () => {
            document.getElementById('status').textContent = 'Connected';
            loadChats();
        };

        ws.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            if (msg.type === 'new_message' && msg.chat_room_id === chatId) {
                addMessage(msg, msg.sender_id !== userId);
            }
        };

        // Load chats
        async function loadChats() {
            const res = await fetch(`/api/users/${userId}/chats`);
            const chats = await res.json();
            const list = document.getElementById('chat-list');

            chats.forEach(chat => {
                const div = document.createElement('div');
                div.className = 'chat-item' + (chat.id === chatId ? ' active' : '');
                div.textContent = chat.name || 'Chat';
                div.onclick = () => selectChat(chat.id, chat.name);
                list.appendChild(div);
            });

            if (chatId) {
                document.getElementById('chat-name').textContent = savedChat.name || 'Chat';
                loadMessages();
            }
        }

        function selectChat(id, name) {
            chatId = id;
            document.getElementById('chat-name').textContent = name;
            document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('messages').innerHTML = '';
            loadMessages();
        }

        async function loadMessages() {
            if (!chatId) return;
            const res = await fetch(`/api/users/${userId}/chats/${chatId}/messages`);
            const msgs = await res.json();
            msgs.reverse().forEach(msg => addMessage(msg, msg.sender_id !== userId));
        }

        function addMessage(msg, isReceived) {
            const div = document.createElement('div');
            div.className = 'message ' + (isReceived ? 'received' : 'sent');

            let content = '';
            if (msg.message_type === 'image') {
                content = `<img src="${msg.media_url}" onclick="window.open('${msg.media_url}','_blank')">`;
            } else {
                content = `<div class="message-bubble">${msg.content}</div>`;
            }

            div.innerHTML = content + `<div class="message-time">${new Date(msg.created_at).toLocaleTimeString()}</div>`;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = 999999;
        }

        function sendText() {
            const input = document.getElementById('input');
            if (!input.value.trim() || !chatId) return;

            ws.send(JSON.stringify({
                type: 'send_message',
                chat_room_id: chatId,
                content: input.value,
                message_type: 'text',
                view_once: false
            }));

            input.value = '';
        }

        async function takeSnap() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;

                setTimeout(() => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0);

                    stream.getTracks().forEach(t => t.stop());

                    const imgData = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                    uploadSnap(imgData);
                }, 500);
            } catch (e) {
                alert('Camera error: ' + e.message);
            }
        }

        async function uploadSnap(base64) {
            const res = await fetch('/api/media/upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    image_data: base64,
                    file_type: 'image/jpeg',
                    expires_in_seconds: 86400
                })
            });

            const data = await res.json();

            ws.send(JSON.stringify({
                type: 'send_message',
                chat_room_id: chatId,
                message_type: 'image',
                media_url: data.url,
                view_once: true
            }));
        }
    </script>
</body>
</html>
