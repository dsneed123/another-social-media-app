<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Relays.Social</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="config.js"></script>
</head>
<body>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            white-space: nowrap;
            border-radius: 8px 8px 0 0;
        }

        .tab:hover {
            color: #fff;
            background: #1a1a1a;
        }

        .tab.active {
            color: #667eea;
            background: #1a1a1a;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
        }

        .stat-card h3 {
            font-size: 14px;
            color: #888;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-card .change {
            font-size: 12px;
            margin-top: 5px;
        }

        .chart-container {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid #333;
        }

        .table-container {
            background: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #333;
        }

        .table-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .table-header h2 {
            font-size: 20px;
        }

        .search-bar {
            padding: 10px 15px;
            background: #0a0a0a;
            border: 1px solid #444;
            border-radius: 8px;
            color: #e0e0e0;
            width: 300px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        th {
            background: #0a0a0a;
            color: #888;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
        }

        tr:hover {
            background: #222;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.active { background: #10b981; color: #fff; }
        .badge.admin { background: #f59e0b; color: #fff; }
        .badge.user { background: #6366f1; color: #fff; }
        .badge.banned { background: #ef4444; color: #fff; }
        .badge.paused { background: #fbbf24; color: #000; }
        .badge.completed { background: #34d399; color: #000; }
        .badge.pending_approval { background: #f59e0b; color: #fff; }
        .badge.pending_payment { background: #a855f7; color: #fff; }
        .badge.rejected { background: #ef4444; color: #fff; }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            margin: 0 5px;
        }

        .btn-primary {
            background: #667eea;
            color: #fff;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #ef4444;
            color: #fff;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: #fff;
        }

        .btn-success:hover {
            background: #059669;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #888;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: #0a0a0a;
            border: 1px solid #444;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #333;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 24px;
        }

        .close-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 28px;
            cursor: pointer;
        }

        .close-btn:hover {
            color: #fff;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
    </style>

    <div class="admin-container">
        <!-- Header -->
        <div class="header">
            <h1><i class="bi bi-shield-shaded"></i> Admin Panel</h1>
            <p>Manage users, campaigns, and monitor analytics</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">
                <i class="bi bi-speedometer2"></i> Dashboard
            </button>
            <button class="tab" onclick="switchTab('users')">
                <i class="bi bi-people"></i> Users
            </button>
            <button class="tab" onclick="switchTab('ads')">
                <i class="bi bi-megaphone"></i> Advertisements
            </button>
            <button class="tab" onclick="switchTab('analytics')">
                <i class="bi bi-graph-up"></i> Analytics
            </button>
            <button class="tab" onclick="switchTab('logs')">
                <i class="bi bi-file-text"></i> Audit Logs
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Users</h3>
                    <div class="value" id="stat-users">-</div>
                </div>
                <div class="stat-card">
                    <h3>Total Stories</h3>
                    <div class="value" id="stat-stories">-</div>
                </div>
                <div class="stat-card">
                    <h3>Active Ads</h3>
                    <div class="value" id="stat-ads">-</div>
                </div>
                <div class="stat-card">
                    <h3>Ad Impressions</h3>
                    <div class="value" id="stat-impressions">-</div>
                </div>
            </div>

            <div class="chart-container">
                <h2 style="margin-bottom: 20px;">User Growth (Last 30 Days)</h2>
                <canvas id="userGrowthChart"></canvas>
            </div>

            <div class="chart-container">
                <h2 style="margin-bottom: 20px;">Engagement Metrics</h2>
                <canvas id="engagementChart"></canvas>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users" class="tab-content">
            <div class="table-container">
                <div class="table-header">
                    <h2>User Management</h2>
                    <input type="text" class="search-bar" placeholder="Search users..." id="user-search">
                </div>
                <div id="users-table-container">
                    <div class="loading">Loading users...</div>
                </div>
            </div>
        </div>

        <!-- Advertisements Tab -->
        <div id="ads" class="tab-content">
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="showCreateAdModal()">
                    <i class="bi bi-plus-circle"></i> Create Campaign
                </button>
            </div>
            <div class="table-container">
                <div class="table-header">
                    <h2>Ad Campaigns</h2>
                </div>
                <div id="ads-table-container">
                    <div class="loading">Loading campaigns...</div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div class="chart-container">
                <h2 style="margin-bottom: 20px;">Daily Active Users</h2>
                <canvas id="dauChart"></canvas>
            </div>
            <div class="chart-container">
                <h2 style="margin-bottom: 20px;">Content Creation</h2>
                <canvas id="contentChart"></canvas>
            </div>
            <div class="chart-container">
                <h2 style="margin-bottom: 20px;">Ad Performance</h2>
                <canvas id="adPerformanceChart"></canvas>
            </div>
        </div>

        <!-- Audit Logs Tab -->
        <div id="logs" class="tab-content">
            <div class="table-container">
                <div class="table-header">
                    <h2>Admin Audit Logs</h2>
                </div>
                <div id="logs-table-container">
                    <div class="loading">Loading logs...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Ad Modal -->
    <div id="createAdModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create Ad Campaign</h2>
                <button class="close-btn" onclick="closeCreateAdModal()">&times;</button>
            </div>
            <form id="createAdForm">
                <div class="form-group">
                    <label>Campaign Title *</label>
                    <input type="text" id="ad-title" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="ad-description"></textarea>
                </div>
                <div class="form-group">
                    <label>Ad Image</label>
                    <input type="file" id="ad-image" accept="image/*">
                    <div id="ad-image-preview" style="margin-top: 10px; display: none;">
                        <img id="ad-image-preview-img" style="max-width: 200px; max-height: 200px; border-radius: 8px;" />
                    </div>
                </div>
                <div class="form-group">
                    <label>Link URL</label>
                    <input type="url" id="ad-link">
                </div>
                <div class="form-group">
                    <label>Target Impressions *</label>
                    <input type="number" id="ad-impressions" min="1" required>
                </div>
                <button type="submit" class="btn btn-primary">Create Campaign</button>
            </form>
        </div>
    </div>

    <script>
        // API Configuration
        const API_URL = CONFIG.API_URL;
        const WS_URL = CONFIG.WS_URL;

        // Check if user is logged in and is admin
        const token = localStorage.getItem('token');
        const userId = localStorage.getItem('userId');

        if (!token || !userId) {
            window.location.href = '/start.html';
        }

        let analyticsData = null;
        let charts = {};

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'users') loadUsers();
            else if (tabName === 'ads') loadAds();
            else if (tabName === 'analytics') loadAnalytics();
            else if (tabName === 'logs') loadLogs();
        }

        // Initialize dashboard
        async function initDashboard() {
            try {
                const response = await fetch(`${API_URL}/api/admin/analytics?days=30`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        alert('Access denied. Admin privileges required.');
                        window.location.href = '/stories.html';
                        return;
                    }
                    throw new Error('Failed to load dashboard');
                }

                const data = await response.json();
                analyticsData = data;

                // Update stat cards
                document.getElementById('stat-users').textContent = data.summary.total_users.toLocaleString();
                document.getElementById('stat-stories').textContent = data.summary.total_stories.toLocaleString();
                document.getElementById('stat-ads').textContent = data.summary.active_ads;
                document.getElementById('stat-impressions').textContent = data.summary.total_ad_impressions.toLocaleString();

                // Create charts
                createUserGrowthChart(data.daily_snapshots);
                createEngagementChart(data.daily_snapshots);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Failed to load dashboard data');
            }
        }

        // User growth chart
        function createUserGrowthChart(snapshots) {
            const ctx = document.getElementById('userGrowthChart').getContext('2d');
            const dates = snapshots.map(s => new Date(s.date).toLocaleDateString());
            const newUsers = snapshots.map(s => s.new_users);
            const totalUsers = snapshots.map(s => s.total_users);

            if (charts.userGrowth) charts.userGrowth.destroy();

            charts.userGrowth = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'New Users',
                            data: newUsers,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Total Users',
                            data: totalUsers,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: '#e0e0e0' } } },
                    scales: {
                        y: { ticks: { color: '#888' }, grid: { color: '#333' } },
                        x: { ticks: { color: '#888' }, grid: { color: '#333' } }
                    }
                }
            });
        }

        // Engagement chart
        function createEngagementChart(snapshots) {
            const ctx = document.getElementById('engagementChart').getContext('2d');
            const dates = snapshots.map(s => new Date(s.date).toLocaleDateString());

            if (charts.engagement) charts.engagement.destroy();

            charts.engagement = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Stories',
                            data: snapshots.map(s => s.new_stories),
                            backgroundColor: '#f59e0b'
                        },
                        {
                            label: 'Messages',
                            data: snapshots.map(s => s.new_messages),
                            backgroundColor: '#8b5cf6'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: '#e0e0e0' } } },
                    scales: {
                        y: { ticks: { color: '#888' }, grid: { color: '#333' } },
                        x: { ticks: { color: '#888' }, grid: { color: '#333' } }
                    }
                }
            });
        }

        // Load users
        async function loadUsers() {
            const container = document.getElementById('users-table-container');
            container.innerHTML = '<div class="loading">Loading users...</div>';

            try {
                const response = await fetch(`${API_URL}/api/admin/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load users');

                const data = await response.json();

                if (data.users.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="bi bi-people"></i><p>No users found</p></div>';
                    return;
                }

                let html = '<table><thead><tr><th>Username</th><th>Email</th><th>Role</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead><tbody>';

                data.users.forEach(user => {
                    const date = new Date(user.created_at).toLocaleDateString();
                    const statusBadge = user.is_banned ? '<span class="badge banned">Banned</span>' : '<span class="badge active">Active</span>';
                    const roleBadge = user.role === 'admin' ? '<span class="badge admin">Admin</span>' : '<span class="badge user">User</span>';

                    html += `<tr>
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td>${roleBadge}</td>
                        <td>${statusBadge}</td>
                        <td>${date || '-'}</td>
                        <td>
                            ${!user.is_banned ?
                                `<button class="btn btn-danger" onclick="banUser('${user.id}', '${user.username}')">Ban</button>` :
                                `<button class="btn btn-success" onclick="unbanUser('${user.id}')">Unban</button>`
                            }
                        </td>
                    </tr>`;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading users:', error);
                container.innerHTML = '<div class="empty-state"><p>Failed to load users</p></div>';
            }
        }

        // Ban user
        async function banUser(userId, username) {
            const reason = prompt(`Ban reason for ${username}:`);
            if (!reason) return;

            try {
                const response = await fetch(`${API_URL}/api/admin/users/${userId}/ban`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason })
                });

                if (response.ok) {
                    alert('User banned successfully');
                    loadUsers();
                } else {
                    alert('Failed to ban user');
                }
            } catch (error) {
                console.error('Error banning user:', error);
                alert('Failed to ban user');
            }
        }

        // Unban user
        async function unbanUser(userId) {
            try {
                const response = await fetch(`${API_URL}/api/admin/users/${userId}/unban`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    alert('User unbanned successfully');
                    loadUsers();
                } else {
                    alert('Failed to unban user');
                }
            } catch (error) {
                console.error('Error unbanning user:', error);
                alert('Failed to unban user');
            }
        }

        // Load ads
        async function loadAds() {
            const container = document.getElementById('ads-table-container');
            container.innerHTML = '<div class="loading">Loading campaigns...</div>';

            try {
                const response = await fetch(`${API_URL}/api/admin/ads`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load ads');

                const ads = await response.json();

                if (ads.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="bi bi-megaphone"></i><p>No campaigns yet</p></div>';
                    return;
                }

                let html = '<table><thead><tr><th>Title</th><th>Status</th><th>Progress</th><th>CTR</th><th>Created</th><th>Actions</th></tr></thead><tbody>';

                ads.forEach(ad => {
                    const progress = ((ad.current_impressions / ad.target_impressions) * 100).toFixed(1);
                    const statusBadge = `<span class="badge ${ad.status}">${ad.status}</span>`;
                    const date = new Date(ad.created_at).toLocaleDateString();

                    // Determine action buttons based on status
                    let actionButtons = '';
                    if (ad.status === 'pending_approval') {
                        actionButtons = `
                            <button class="btn btn-success" onclick="approveAd('${ad.id}')" style="margin-right: 8px;">Approve</button>
                            <button class="btn btn-danger" onclick="rejectAd('${ad.id}')">Reject</button>
                        `;
                    } else if (ad.status === 'active') {
                        actionButtons = `<button class="btn btn-primary" onclick="pauseAd('${ad.id}')">Pause</button>`;
                    } else if (ad.status === 'paused') {
                        actionButtons = `<button class="btn btn-success" onclick="resumeAd('${ad.id}')">Resume</button>`;
                    } else if (ad.status === 'pending_payment') {
                        actionButtons = `<span style="color: #888;">Awaiting payment</span>`;
                    } else if (ad.status === 'rejected' || ad.status === 'completed') {
                        actionButtons = `<span style="color: #888;">â€”</span>`;
                    }

                    html += `<tr>
                        <td>${ad.title}</td>
                        <td>${statusBadge}</td>
                        <td>${ad.current_impressions} / ${ad.target_impressions} (${progress}%)</td>
                        <td>${ad.ctr_percentage.toFixed(2)}%</td>
                        <td>${date}</td>
                        <td>${actionButtons}</td>
                    </tr>`;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading ads:', error);
                container.innerHTML = '<div class="empty-state"><p>Failed to load campaigns</p></div>';
            }
        }

        // Create ad modal
        function showCreateAdModal() {
            document.getElementById('createAdModal').classList.add('show');
        }

        function closeCreateAdModal() {
            document.getElementById('createAdModal').classList.remove('show');
        }

        // Image preview handler
        document.getElementById('ad-image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('ad-image-preview-img').src = event.target.result;
                    document.getElementById('ad-image-preview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('createAdForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            let imageUrl = null;

            // Upload image if selected
            const imageFile = document.getElementById('ad-image').files[0];
            if (imageFile) {
                try {
                    const formData = new FormData();
                    formData.append('file', imageFile);

                    const uploadResponse = await fetch(`${API_URL}/api/media/upload-multipart`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!uploadResponse.ok) throw new Error('Failed to upload image');

                    const uploadData = await uploadResponse.json();
                    imageUrl = uploadData.url;
                } catch (error) {
                    console.error('Error uploading image:', error);
                    alert('Failed to upload image');
                    return;
                }
            }

            const data = {
                title: document.getElementById('ad-title').value,
                description: document.getElementById('ad-description').value || null,
                image_url: imageUrl,
                link_url: document.getElementById('ad-link').value || null,
                target_impressions: parseInt(document.getElementById('ad-impressions').value)
            };

            try {
                const response = await fetch(`${API_URL}/api/admin/ads`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('Campaign created successfully!');
                    closeCreateAdModal();
                    loadAds();
                    e.target.reset();
                } else {
                    alert('Failed to create campaign');
                }
            } catch (error) {
                console.error('Error creating ad:', error);
                alert('Failed to create campaign');
            }
        });

        // Pause/resume ad
        async function pauseAd(adId) {
            await updateAdStatus(adId, 'paused');
        }

        async function resumeAd(adId) {
            await updateAdStatus(adId, 'active');
        }

        // Approve/reject ad (for pending_approval ads)
        async function approveAd(adId) {
            if (!confirm('Approve this ad campaign?')) return;

            try {
                const response = await fetch(`${API_URL}/api/admin/ads/${adId}/approve`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    alert('Ad approved and activated!');
                    loadAds();
                } else {
                    alert('Failed to approve ad');
                }
            } catch (error) {
                console.error('Error approving ad:', error);
                alert('Failed to approve ad');
            }
        }

        async function rejectAd(adId) {
            if (!confirm('Reject this ad campaign? This action cannot be undone.')) return;

            try {
                const response = await fetch(`${API_URL}/api/admin/ads/${adId}/reject`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    alert('Ad rejected');
                    loadAds();
                } else {
                    alert('Failed to reject ad');
                }
            } catch (error) {
                console.error('Error rejecting ad:', error);
                alert('Failed to reject ad');
            }
        }

        async function updateAdStatus(adId, status) {
            try {
                const response = await fetch(`${API_URL}/api/admin/ads/${adId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });

                if (response.ok) {
                    alert('Ad updated successfully');
                    loadAds();
                } else {
                    alert('Failed to update ad');
                }
            } catch (error) {
                console.error('Error updating ad:', error);
                alert('Failed to update ad');
            }
        }

        // Load analytics
        async function loadAnalytics() {
            if (!analyticsData) await initDashboard();
            // Charts already created in dashboard
        }

        // Load logs
        async function loadLogs() {
            const container = document.getElementById('logs-table-container');
            container.innerHTML = '<div class="loading">Loading logs...</div>';

            try {
                const response = await fetch(`${API_URL}/api/admin/logs`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load logs');

                const data = await response.json();

                if (data.logs.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="bi bi-file-text"></i><p>No logs yet</p></div>';
                    return;
                }

                let html = '<table><thead><tr><th>Time</th><th>Admin</th><th>Action</th><th>Target</th></tr></thead><tbody>';

                data.logs.forEach(log => {
                    const time = new Date(log.created_at).toLocaleString();
                    html += `<tr>
                        <td>${time}</td>
                        <td>${log.admin_username || 'Unknown'}</td>
                        <td>${log.action}</td>
                        <td>${log.target_username || '-'}</td>
                    </tr>`;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading logs:', error);
                container.innerHTML = '<div class="empty-state"><p>Failed to load logs</p></div>';
            }
        }

        // Initialize on load
        initDashboard();
    </script>
</body>
</html>
